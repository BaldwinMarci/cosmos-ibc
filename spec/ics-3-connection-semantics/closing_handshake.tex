\include{common}

\begin{document}
\begin{varwidth}{\linewidth}

\begin{algorithmic}
\Struct[Datagram]{ConnCloseInit}
\Field{Identifier}{identifier}
\Field{Identifier}{identifierCounterparty}
\EndStruct
\end{algorithmic}

\begin{algorithmic}
\Struct[Datagram]{ConnCloseTry}
\Field{Identifier}{identifier}
\Field{Identifier}{identifierCounterparty}
\Field{AccumulatorProof}{proofInit}
\EndStruct
\end{algorithmic}

\begin{algorithmic}
\Struct[Datagram]{ConnCloseAck}
\Field{Identifier}{identifier}
\Field{AccumulatorProof}{proofTry}
\EndStruct
\end{algorithmic}

\begin{algorithmic}
\Function{handleDatagram}{datagram}
  \Switch{$datagram$}
    \Case{$ConnCloseInit$}
      \State $(state, version, counterpartyIdentifier, rootOfTrust) \gets$ \Call{Get}{identifier}
      \Assert{$state == OPEN$}
      \Assert{$identifierCounterparty == counterpartyIdentifier$}
      \State $state \gets TRYCLOSE$
      \State \Call{Set}{identifier, (state, version, counterpartyIdentifier, rootOfTrust)}
    \EndCase
    \Case{$ConnCloseTry$}
      \State $(state, version, counterpartyIdentifier, rootOfTrust) \gets$ \Call{Get}{identifier}
      \Assert{$state == OPEN$}
      \Assert{$identifierCounterparty == counterpartyIdentifier$}
      \Assert{\Call{verify}{rootOfTrust, proofInit, (counterpartyIdentifier, TRYCLOSE)}}
      \State $state \gets CLOSED$
      \State \Call{Set}{identifier, (state, version, counterpartyIdentifier, rootOfTrust)}
    \EndCase
    \Case{$ConnCloseAck$}
      \State $(state, version, counterpartyIdentifier, rootOfTrust) \gets$ \Call{Get}{identifier}
      \Assert{$state == TRYCLOSE$}
      \Assert{\Call{verify}{rootOfTrust, proofTry, (counterpartyIdentifier, CLOSED)}}
      \State $state \gets CLOSED$
      \State \Call{Set}{identifier, (state, version, counterpartyIdentifier, rootOfTrust)}
    \EndCase
  \EndSwitch
\EndFunction
\end{algorithmic}

\end{varwidth}
\end{document}
