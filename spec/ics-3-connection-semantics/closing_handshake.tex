\include{common}

\begin{document}
\begin{varwidth}{\linewidth}

\begin{algorithmic}
\Struct[Datagram]{CONNCLOSEINIT}
\Field{Identifier}{identifierA}
\Field{Identifier}{identifierB}
\EndStruct
\end{algorithmic}

\begin{algorithmic}
\Struct[Datagram]{CONNCLOSETRY}
\Field{Identifier}{identifierA}
\Field{Identifier}{identifierB}
\Field{AccumulatorProof}{proofInitA}
\EndStruct
\end{algorithmic}

\begin{algorithmic}
\Struct[Datagram]{CONNCLOSEACK}
\Field{Identifier}{identifier}
\Field{AccumulatorProof}{proofTryB}
\EndStruct
\end{algorithmic}

\begin{algorithmic}
\Function{handleDatagram}{datagram}
  \Switch{$datagram$}
    \Case{$CONNCLOSEINIT$}
      \State $(state, version, counterpartyIdentifier, rootOfTrust) \gets$ \Call{Get}{identifierA}
      \Assert{$state == OPEN$}
      \Assert{$identifierB == counterpartyIdentifier$}
      \State $state \gets TRYCLOSE$
      \State \Call{Set}{identifierA, (state, version, counterpartyIdentifier, rootOfTrust)}
    \EndCase
    \Case{$CONNCLOSETRY$}
      \State $(state, version, counterpartyIdentifier, rootOfTrust) \gets$ \Call{Get}{identifierB}
      \Assert{$state == OPEN$}
      \Assert{\Call{verify}{rootOfTrust, proofInitA}}
      \State $state \gets CLOSED$
      \State \Call{Set}{identifierB, (state, version, counterpartyIdentifier, rootOfTrust)}
    \EndCase
    \Case{$CONNCLOSEACK$}
      \State $(state, version, counterpartyIdentifier, rootOfTrust) \gets$ \Call{Get}{identifierA}
      \Assert{$state == TRYCLOSE$}
      \Assert{\Call{verify}{rootOfTrustB, proofTryB}}
      \State $state \gets CLOSED$
      \State \Call{Set}{identifier, (state, version, counterpartyIdentifier, rootOfTrust)}
    \EndCase
  \EndSwitch
\EndFunction
\end{algorithmic}

\end{varwidth}
\end{document}
