\include{common}

\begin{document}
\begin{varwidth}{\linewidth}

\begin{algorithmic}
\Struct[Datagram]{CONNOPENINIT}
\Field{Identifier}{identifier}
\Field{Identifier}{desiredCounterpartyIdentifier}
\Field{Version}{desiredVersion}
\Field{RootOfTrust}{rootOfTrust}
\EndStruct
\end{algorithmic}

\begin{algorithmic}
\Struct[Datagram]{CONNOPENTRY}
\Field{Identifier}{desiredIdentifier}
\Field{Identifier}{counterpartyIdentifier}
\Field{Version}{desiredVersion}
\Field{RootOfTrust}{rootOfTrust}
\Field{AccumulatorProof}{proofInit}
\EndStruct
\end{algorithmic}

\begin{algorithmic}
\Struct[Datagram]{CONNOPENACK}
\Field{Identifier}{identifier}
\Field{Identifier}{agreedCounterpartyIdentifier}
\Field{Version}{agreedVersion}
\Field{AccumulatorProof}{proofTry}
\EndStruct
\end{algorithmic}

\begin{algorithmic}
\Struct[Datagram]{CONNOPENCONFIRM}
\Field{Identifier}{identifier}
\Field{AccumulatorProof}{proofAck}
\EndStruct
\end{algorithmic}

\begin{algorithmic}
\Function{handleDatagram}{datagram}
  \Switch{$datagram$}
    \Case{$CONNOPENINIT$}
      \State $state \gets INIT$
      \State \Call{Set}{identifier, (state, desiredVersion, desiredCounterpartyIdentifier, rootOfTrust)}
    \EndCase
    \Case{$CONNOPENTRY$}
      \State $expectedRootOfTrust \gets$ \Call{getRootOfTrust}{ }
      \Assert{\Call{verify}{rootOfTrust, proofInit,\par
        \hskip3em (counterpartyIdentifier, (INIT, desiredVersion, desiredIdentifier, expectedRootOfTrust))}}
      \State $identifier \gets$ \Call{chooseIdentifier}{desiredIdentifier}
      \State $version \gets$ \Call{chooseVersion}{desiredVersion}
      \State $state \gets OPENTRY$
      \State \Call{Set}{identifier, (state, version, counterpartyIdentifier, rootOfTrust)}
    \EndCase
    \Case{$CONNOPENACK$}
      \State $(state, desiredVersion, desiredCounterpartyIdentifier, rootOfTrust) \gets $\Call{Get}{identifier}
      \Assert{$state == INIT$}
      \State $expectedRootOfTrust \gets$ \Call{getRootOfTrust}{ }
      \Assert{\Call{verify}{rootOfTrust, proofTry,\par
        \hskip3em (agreedCounterpartyIdentifier, (OPENTRY, agreedVersion, identifier, expectedRootOfTrust))}}
      \Assert{\Call{checkIdentifier}{desiredCounterpartyIdentifier, agreedCounterpartyIdentifier}}
      \Assert{\Call{checkVersion}{desiredVersion, agreedVersion}}
      \State $state \gets OPEN$
      \State \Call{Set}{identifier, (state, agreedVersion, agreedCounterpartyIdentifier, rootOfTrust)}
    \EndCase
    \Case{$CONNOPENCONFIRM$}
      \State $(state, version, counterpartyIdentifier, rootOfTrust) \gets$ \Call{Get}{identifier}
      \Assert{$state == OPENTRY$}
      \State $expectedRootOfTrust \gets$ \Call{getRootOfTrust}{ }
      \Assert{\Call{verify}{rootOfTrust, proofAck,\par
        \hskip3em (counterpartyIdentifier, (OPEN, version, identifier, expectedRootOfTrust)}}
      \State $state \gets OPEN$
      \State \Call{Set}{identifier, (state, version, counterpartyIdentifier, rootOfTrust)}
    \EndCase
  \EndSwitch
\EndFunction
\end{algorithmic}

\end{varwidth}
\end{document}
