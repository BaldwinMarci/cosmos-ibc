\include{common}

\begin{document}
\begin{varwidth}{\linewidth}

\begin{algorithmic}
\Struct[Datagram]{CONNOPENINIT}
\Field{Version}{desiredVersion}
\Field{RootOfTrust}{rootOfTrustB}
\Field{Identifier}{identifierA}
\Field{Identifier}{desiredIdentifierB}
\EndStruct
\end{algorithmic}

\begin{algorithmic}
\Struct[Datagram]{CONNOPENTRY}
\Field{Version}{desiredVersion}
\Field{RootOfTrust}{rootOfTrustA}
\Field{Identifier}{identifierA}
\Field{Identifier}{desiredIdentifierB}
\Field{AccumulatorProof}{proofInitA}
\EndStruct
\end{algorithmic}

\begin{algorithmic}
\Struct[Datagram]{CONNOPENACK}
\Field{Version}{agreedVersion}
\Field{Identifier}{identifierA}
\Field{Identifier}{agreedIdentifierB}
\Field{AccumulatorProof}{proofTryB}
\EndStruct
\end{algorithmic}

\begin{algorithmic}
\Struct[Datagram]{CONNOPENCONFIRM}
\Field{Identifier}{identifierB}
\Field{AccumulatorProof}{proofAckA}
\EndStruct
\end{algorithmic}

\begin{algorithmic}
\Function{handleDatagram}{datagram}
  \Switch{$datagram$}
    \Case{$CONNOPENINIT$}
      \State $state \gets INIT$
      \State \Call{Set}{identifierA, (state, desiredVersion, desiredIdentifierB, rootOfTrustB)}
    \EndCase
    \Case{$CONNOPENTRY$}
      \Assert{\Call{verify}{rootOfTrustA, proofInitA}}
      \Assert{\Call{getRootOfTrust}{ } $==$ rootOfTrustB}
      \State $identifierB \gets$ \Call{chooseIdentifier}{desiredIdentifierB}
      \State $versionB \gets$ \Call{chooseVersion}{desiredVersionB}
      \State \Call{Set}{identifierB, (state, version, identifierA, rootOfTrustA)}
      \State $state \gets OPENTRY$
    \EndCase
    \Case{$CONNOPENACK$}
      \State $(state, desiredVersionB, desiredIdentifierB, rootOfTrustB) \gets $\Call{Get}{identifierA}
      \Assert{$state == INIT$}
      \Assert{\Call{verify}{rootOfTrustB, proofTryB}}
      \Assert{\Call{getRootOfTrust}{ } $==$ rootOfTrustA}
      \Assert{\Call{checkIdentifier}{desiredIdentifierB, identifierB}}
      \Assert{\Call{checkVersion}{desiredVersion, version}}
      \State $state \gets OPEN$
      \State \Call{Set}{identifierA, <version, rootOfTrustB, identifierB, state>}
    \EndCase
    \Case{$CONNOPENCONFIRM$}
      \State $(state, version, identifierB, rootOfTrustB) \gets$ \Call{Get}{identifierB}
      \Assert{$state == OPENTRY$}
      \Assert{\Call{verify}{rootOfTrustA, proofAckA}}
      \State $state \gets OPEN$
    \EndCase
  \EndSwitch
\EndFunction
\end{algorithmic}

\end{varwidth}
\end{document}
